#!/bin/sh

# this will get the CCID from the Gemalto - it can fail up to 10 times.  If it fails - no CCID will be set
# The IMEI is set in both 'db-config RedStone IMEI' and in /mnt/nvram/rom/imei
#
# This is usually called by check-for-IMEI on first boot and shouldn't need to be called directly.
#

#=========================================================================================
WaitForModemPorts ()
{
ready=0
count=0
#wait for ttyGPSAT to appear
while [ "$ready" == "0"	]
do
	if [ -e /dev/ttyGPSAT ]; then
		ready=1
		echo -e "ate0\r" > /dev/ttyGPSAT
	else
		sleep 1
		count=`expr $count + 1`

		if [ "$#" -eq "1"  ]; then
			if [ "$count" -ge "$1" ]; then
				exit
			fi
		fi
	fi
done

ready=0
count=0

#wait for ttyGPS to appear
while [ "$ready" == "0"	]
do
	if [ -e /dev/ttyGPS ]; then
		ready=1
		echo -e "ate0\r" > /dev/ttyGPS
	else
		sleep 1
		count=`expr $count + 1`

		if [ "$#" -eq "1"  ]; then
			if [ "$count" -ge "$1" ]; then
				exit
			fi
		fi
	fi
done


}

#=========================================================================================
#main


WaitForModemPorts 30

done=0
count=0
mport="/dev/ttyGPSAT"


while [ "$done" -eq "0" ]
do
	echo -e "at\r" > $mport
	cat $mport >> ~/ccid.raw &
	thePID=$!
	sleep 1
	echo -e "at+CCID\r" > $mport
	sleep 2

	kill $thePID
	ccid=$(grep CCID ~/ccid.raw | awk 'BEGIN {FS=" "}{print $2}')
	if [ "14" -lt  "${#ccid}" ]; then
		done=1
		db-config set Cellular CCID $ccid
		echo "$ccid"
	fi
	
	count=`expr $count + 1`
	
	if [ "$count" -ge "5" ]; then
		done=1
		if [ "$mport" == "/dev/ttyGPSAT" ]; then
			count=0
			done=0
			mport="/dev/ttyGPS"
		fi
	fi
done

if [ -e ~/ccid.raw ]; then 
	rm ~/ccid.raw
fi 

